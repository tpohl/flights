<div class="flight-anomalies-container">
  <header class="page-header">
    <h1 class="page-title">Flight Anomalies</h1>
    <span class="subtitle"> <strong>{{ totalAnomalies() }}</strong> Flights with unusual speeds that may contain data errors</span>
  </header>

  <div class="main-content">

    <!-- Filters -->
    <section class="filters-container glass-card">
      <div class="filter-group">
        <mat-checkbox [(ngModel)]="showTooSlow" color="warn">
          Too Slow ({{ tooSlowFlights().length }})
        </mat-checkbox>
        <mat-checkbox [(ngModel)]="showTooFast" color="warn">
          Too Fast ({{ tooFastFlights().length }})
        </mat-checkbox>
        <mat-checkbox [(ngModel)]="showInvalid" color="warn">
          Invalid ({{ invalidFlights().length }})
        </mat-checkbox>
        <mat-checkbox [(ngModel)]="showIncomplete" color="warn">
          Incomplete ({{ incompleteFlights().length }})
        </mat-checkbox>
        <mat-checkbox [(ngModel)]="showValidated" color="primary">
          Validated ({{ totalValidated() }})
        </mat-checkbox>
      </div>

      @if (showIncomplete()) {
      <div class="bulk-actions">
        <button mat-raised-button color="warn"
          (click)="deleteAllIncompleteFlights()"
          [disabled]="deletingAllIncomplete()"
          class="delete-all-btn">
          @if (deletingAllIncomplete()) {
            <mat-progress-spinner diameter="20" mode="indeterminate"></mat-progress-spinner>
            <span>Deleting...</span>
          } @else {
            <mat-icon>delete_sweep</mat-icon>
            <span>Delete All Incomplete ({{ incompleteFlights().length }})</span>
          }
        </button>
      </div>
      }
    </section>

    <!-- Content -->
    @if (displayedFlights().length === 0) {
    <div class="empty-state">
      <mat-icon>thumb_up</mat-icon>
      <p>No flights match your selection!</p>
    </div>
    } @else {
    <section class="flights-grid">
      @for (flight of displayedFlights(); track flight._id) {
      <app-flight-card [flight]="flight" [validated]="getAnomalyType(flight) === 'validated'">
        <div class="anomaly-content">
          <!-- Badge logic -->
          @if (getAnomalyType(flight) === 'validated') {
          <div class="anomaly-badge validated">
            <mat-icon>verified</mat-icon>
            <span>Validated</span>
          </div>
          } @else if (getAnomalyType(flight) === 'slow') {
          <div class="anomaly-badge slow">
            <mat-icon>warning</mat-icon>
            <span>Very Slow</span>
          </div>
          } @else if (getAnomalyType(flight) === 'incomplete') {
          <div class="anomaly-badge incomplete">
            <mat-icon>error_outline</mat-icon>
            <span>Incomplete</span>
          </div>
          } @else if (getAnomalyType(flight) === 'invalid') {
          <div class="anomaly-badge invalid">
            <mat-icon>error</mat-icon>
            <span>Invalid</span>
          </div>
          } @else {
          <div class="anomaly-badge fast">
            <mat-icon>warning</mat-icon>
            <span>Very Fast</span>
          </div>
          }

          <app-flight-tile [flight]="flight"></app-flight-tile>

          <div class="speed-info">
            <div class="info-metrics">
              @if (isIncompleteAnomaly(flight)) {
              <div class="metric incomplete-info">
                <span class="label">Missing Data:</span>
                <span class="value invalid">
                  @if (!flight.departureTime) { Departure Time }
                  @if (!flight.from) { @if (!flight.departureTime) {, } Origin }
                  @if (!flight.to) { @if (!flight.departureTime || !flight.from) {, } Destination }
                </span>
              </div>
              } @else if (isInvalidAnomaly(flight)) {
              <div class="metric">
                <span class="label">Duration:</span>
                <span class="value invalid">
                  @if (flight.durationMilliseconds < 0) { Negative Duration } @else { Missing Duration } </span>
              </div>
              @if (!flight.distance || flight.distance <= 0) { <div class="metric">
                <span class="label">Distance:</span>
                <span class="value invalid">Missing Distance</span>
            </div>
            }
            } @else {
            <div class="metric">
              <span class="label">Average Speed:</span>
              <span class="value">{{ calculateAverageSpeed(flight) | number: '1.0-0' }} km/h</span>
            </div>
            }
          </div>

          <div class="badge-and-actions">
            @if (getAnomalyType(flight) === 'validated') {
            <span class="type-badge" [class.slow]="isSlowAnomaly(flight)" [class.fast]="isFastAnomaly(flight)"
              [class.invalid]="isInvalidAnomaly(flight)">
              @if (isSlowAnomaly(flight)) { Slow } @else if (isFastAnomaly(flight)) { Fast } @else { Invalid }
            </span>
            }

            @if (isIncompleteAnomaly(flight)) {
            <button mat-icon-button color="warn" class="delete-btn"
              (click)="deleteFlight(flight); $event.stopPropagation(); $event.preventDefault()"
              [disabled]="deletingFlightId() === flight._id" matTooltip="Delete Incomplete Flight">
              @if (deletingFlightId() === flight._id) {
              <mat-progress-spinner diameter="20" mode="indeterminate"></mat-progress-spinner>
              } @else {
              <mat-icon>delete</mat-icon>
              }
            </button>
            } @else if (isMissingData(flight)) {
            <button mat-icon-button color="primary" class="recalculate-btn"
              (click)="recalculate(flight); $event.stopPropagation(); $event.preventDefault()"
              [disabled]="recalculatingFlightId() === flight._id" matTooltip="Recalculate Duration & Distance">
              @if (recalculatingFlightId() === flight._id) {
              <mat-progress-spinner diameter="20" mode="indeterminate"></mat-progress-spinner>
              } @else {
              <mat-icon>refresh</mat-icon>
              }
            </button>
            }
          </div>
        </div>
  </div>
  </app-flight-card>
  }
  </section>
  }

  <!-- Back to Flights button -->
  <div class="action-buttons">
    <button mat-raised-button color="primary" [routerLink]="['/flights']">
      <mat-icon>arrow_back</mat-icon>
      Back to Flights
    </button>
  </div>
</div>
</div>