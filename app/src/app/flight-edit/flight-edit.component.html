<div class="edit-container">
  @if (flight(); as f) {
  <!-- Header -->
  <div class="edit-header">
    <div class="header-content">
      <h1 class="page-title">
        @if (!!f._id) {
        Edit Flight
        } @else {
        New Flight
        }
      </h1>
      @if (!!f._id) {
      <p class="flight-summary">{{ f.from }} → {{ f.to }} · {{ f.departureTime | amTimeAgo }}</p>
      }
    </div>
    <a mat-icon-button routerLink="/flights" aria-label="Close" class="close-button">
      <mat-icon>close</mat-icon>
    </a>
  </div>

  <div [class.is-disabled]="!f._id">
    <!-- Flight Preview Card -->
    <mat-card class="preview-card glass-card">
      <mat-card-content>
        <!-- Anomaly Badge -->
        @if (isFlightAnomaly() && !f.validatedAnomaly) {
        <div class="anomaly-alert">
          <mat-icon class="alert-icon">warning</mat-icon>
          <div class="alert-text">
            <strong>
              @if (isSlowAnomaly()) {
              This flight is very slow
              } @else if (isFastAnomaly()) {
              This flight is very fast
              }
            </strong>
            <p>Average speed: {{ flightsService.getAverageSpeed(f) | number: '1.0-0' }} km/h</p>
            <p class="alert-description">
              This may indicate a data entry error. Please verify the departure/arrival times or distance.
            </p>
            <button mat-raised-button color="accent" (click)="validateAnomaly()" class="validate-btn">
              <mat-icon>check_circle</mat-icon>
              Validate - This is correct
            </button>
          </div>
        </div>
        }

        @if (isFlightAnomaly() && f.validatedAnomaly) {
        <div class="validated-anomaly-badge">
          <mat-icon>verified</mat-icon>
          <span>Validated Anomaly</span>
          <button mat-icon-button (click)="validateAnomaly()" matTooltip="Remove validation">
            <mat-icon>delete</mat-icon>
          </button>
        </div>
        }

        <app-flight-tile [flight]="f"></app-flight-tile>
      </mat-card-content>
    </mat-card>

    <!-- Map -->
    <div class="map-container">
      <app-cesium [flights]="flightsForMap()" [timelineMode]="false"></app-cesium>
    </div>

    <!-- Flight Stats -->
    <div class="stats-container">
      <app-flight-stats [flight]="f"></app-flight-stats>
    </div>
  </div>

  <!-- Edit Form -->
  <mat-card class="form-card glass-card" #formCard>
    <mat-card-header>
      <mat-card-title>Flight Details</mat-card-title>
    </mat-card-header>

    <mat-card-content>
      <div class="form-grid">
        <!-- Date -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Date</mat-label>
          <input matInput [matDatepicker]="picker" [value]="f.date" (dateChange)="onDateChange($event)"
            placeholder="YYYY-MM-DD">
          <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
          <mat-datepicker #picker></mat-datepicker>
        </mat-form-field>

        <!-- Flight Number with autocomplete -->
        <div class="input-with-action">
          <mat-form-field appearance="outline" class="flex-grow">
            <mat-label>Flight Number</mat-label>
            <input matInput [(ngModel)]="f.flightno" placeholder="e.g. LH123">
            <mat-icon matSuffix>flight</mat-icon>
          </mat-form-field>
          <button mat-icon-button (click)="autocomplete()" [class.loading]="f.needsAutocomplete"
            matTooltip="Auto-complete flight info">
            <mat-icon>auto_fix_high</mat-icon>
          </button>
        </div>

        <mat-divider></mat-divider>

        <!-- From Airport -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>From</mat-label>
          <input matInput [(ngModel)]="f.from" placeholder="Origin (e.g. VIE)">
          <mat-hint>{{ fromAirport()?.name }}</mat-hint>
        </mat-form-field>

        <!-- To Airport -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>To</mat-label>
          <input matInput [(ngModel)]="f.to" placeholder="Destination (e.g. HAM)">
          <mat-hint>{{ toAirport()?.name }}</mat-hint>
        </mat-form-field>

        <mat-divider></mat-divider>

        <!-- Departure Time -->
        <div class="input-with-action">
          <mat-form-field appearance="outline" class="flex-grow">
            <mat-label>Departure Time</mat-label>
            <input matInput type="time" [(ngModel)]="departureTime">
          </mat-form-field>
          <button mat-icon-button (click)="selectDepartureTime()" matTooltip="Set departure time">
            <mat-icon>schedule</mat-icon>
          </button>
        </div>

        <!-- Arrival Time -->
        <div class="input-with-action">
          <mat-form-field appearance="outline" class="flex-grow">
            <mat-label>Arrival Time</mat-label>
            <input matInput type="time" [(ngModel)]="arrivalTime">
          </mat-form-field>
          <button mat-icon-button (click)="selectArrivalTime()" matTooltip="Set arrival time">
            <mat-icon>schedule</mat-icon>
          </button>
        </div>

        <!-- Distance -->
        <div class="input-with-action">
          <mat-form-field appearance="outline" class="flex-grow">
            <mat-label>Distance</mat-label>
            <input matInput [(ngModel)]="f.distance" placeholder="Distance in km">
            <mat-hint>Flown: {{ f | flightDistance | number : '1.0-0' }} km</mat-hint>
          </mat-form-field>
          @if (f._id && isMissingData()) {
          <button mat-icon-button (click)="recalculate()" [disabled]="isRecalculating()"
            matTooltip="Recalculate Duration & Distance">
            @if (isRecalculating()) {
            <mat-progress-spinner diameter="20" mode="indeterminate"></mat-progress-spinner>
            } @else {
            <mat-icon>refresh</mat-icon>
            }
          </button>
          }
        </div>

        <!-- Duration (read-only) -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Duration</mat-label>
          <input matInput [value]="f.durationMilliseconds | amDurationExact:'milliseconds'" readonly>
          <mat-icon matSuffix>timer</mat-icon>
        </mat-form-field>

        <mat-divider></mat-divider>

        <!-- Aircraft Type -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Aircraft Type Code</mat-label>
          <input matInput [(ngModel)]="f.aircraftTypeCode" placeholder="e.g. A320">
          <mat-hint>{{ f.aircraftType }}</mat-hint>
        </mat-form-field>

        <!-- Aircraft Registration -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Aircraft Registration</mat-label>
          <input matInput [(ngModel)]="f.aircraftRegistration" placeholder="e.g. OE-LBL">
        </mat-form-field>

        <mat-divider></mat-divider>

        <!-- Seat -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Seat</mat-label>
          <input matInput [(ngModel)]="f.seat" placeholder="e.g. 12A">
          <mat-icon matSuffix>airline_seat_recline_normal</mat-icon>
        </mat-form-field>

        <!-- Seat Type -->
        <div class="radio-group-container">
          <label class="radio-label">Seat Type</label>
          <mat-radio-group [(ngModel)]="f.seatType" class="radio-group">
            <mat-radio-button value="A">Aisle</mat-radio-button>
            <mat-radio-button value="M">Middle</mat-radio-button>
            <mat-radio-button value="W">Window</mat-radio-button>
          </mat-radio-group>
        </div>

        <!-- Class -->
        <div class="radio-group-container">
          <label class="radio-label">Class</label>
          <mat-radio-group [(ngModel)]="f.class" class="radio-group">
            @for (travelClass of TRAVEL_CLASSES_LIST; track travelClass.key) {
            <mat-radio-button [value]="travelClass.key">{{ travelClass.long }}</mat-radio-button>
            }
          </mat-radio-group>
        </div>

        <!-- Reason -->
        <div class="radio-group-container">
          <label class="radio-label">Reason</label>
          <mat-radio-group [(ngModel)]="f.reason" class="radio-group">
            <mat-radio-button value="B">Work</mat-radio-button>
            <mat-radio-button value="L">Leisure</mat-radio-button>
            <mat-radio-button value="C">Crew</mat-radio-button>
            <mat-radio-button value="O">Other</mat-radio-button>
          </mat-radio-group>
        </div>

        <mat-divider></mat-divider>

        <!-- Carrier -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Carrier</mat-label>
          <input matInput [(ngModel)]="f.carrier" placeholder="e.g. Austrian Airlines">
        </mat-form-field>

        <!-- Name -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Name</mat-label>
          <input matInput [(ngModel)]="f.name" placeholder="Flight name">
        </mat-form-field>

        <!-- Note -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Note</mat-label>
          <input matInput [(ngModel)]="f.note" placeholder="Additional notes">
        </mat-form-field>

        <!-- Error Message -->
        @if (f.errorMessage) {
        <div class="error-message">
          <mat-icon>error</mat-icon>
          <span>{{ f.errorMessage }}</span>
        </div>
        }
      </div>
    </mat-card-content>

    <!-- Actions -->
    <mat-card-actions class="form-actions">
      <button mat-flat-button color="primary" (click)="save()" class="save-button">
        <mat-icon>save</mat-icon>
        Save
      </button>

      <button mat-stroked-button color="warn" (click)="delete()" class="delete-button">
        <mat-icon>delete_outline</mat-icon>
        Delete
      </button>
    </mat-card-actions>
  </mat-card>
  }
</div>