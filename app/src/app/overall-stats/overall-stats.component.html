<div class="stats-container">
    <div class="header-section">
        <h1 class="page-title">Statistics</h1>

        <button mat-button [matMenuTriggerFor]="yearMenu" class="year-trigger glass-button">
            {{ selectedYear() || 'All Years' }} <mat-icon>arrow_drop_down</mat-icon>
        </button>
        <mat-menu #yearMenu="matMenu" class="glass-menu">
            <button mat-menu-item (click)="setYear(null)" [class.selected]="selectedYear() === null">All Years</button>
            @for (year of availableYears(); track year) {
            <button mat-menu-item (click)="setYear(year)" [class.selected]="selectedYear() === year">
                {{ year }}
            </button>
            }
        </mat-menu>
    </div>

    <!-- Main Stats Panel -->
    <app-flight-summary-card [stats]="stats()"></app-flight-summary-card>

    <!-- Records Card -->
    <mat-card class="stats-card glass-card">
        <mat-card-header>
            <mat-icon mat-card-avatar>workspace_premium</mat-icon>
            <mat-card-title>Records</mat-card-title>
        </mat-card-header>
        <mat-card-content>
            <mat-list>
                @if (stats().longestFlight) {
                <mat-list-item [routerLink]="['/flight', stats().longestFlight?._id]" class="clickable-item">
                    <mat-icon matListItemIcon>straighten</mat-icon>
                    <span matListItemTitle>Longest Flight</span>
                    <span matListItemLine>{{ stats().longestFlight?.from }} → {{ stats().longestFlight?.to }} · {{
                        stats().longestFlight?.date }}</span>
                    <span matListItemMeta class="stat-value">{{ stats().longestFlight?.distance | number : '1.0-0' }}
                        km</span>
                </mat-list-item>
                }
                <mat-divider></mat-divider>
                @if (stats().shortestFlight) {
                <mat-list-item [routerLink]="['/flight', stats().shortestFlight?._id]" class="clickable-item">
                    <mat-icon matListItemIcon>compress</mat-icon>
                    <span matListItemTitle>Shortest Flight</span>
                    <span matListItemLine>{{ stats().shortestFlight?.from }} → {{ stats().shortestFlight?.to }} · {{
                        stats().shortestFlight?.date }}</span>
                    <span matListItemMeta class="stat-value">{{ stats().shortestFlight?.distance | number : '1.0-0' }}
                        km</span>
                </mat-list-item>
                }
                <mat-divider></mat-divider>
                @if (stats().fastestFlight) {
                <mat-list-item [routerLink]="['/flight', stats().fastestFlight?._id]" class="clickable-item">
                    <mat-icon matListItemIcon>speed</mat-icon>
                    <span matListItemTitle>Fastest Flight</span>
                    <span matListItemLine>{{ stats().fastestFlight?.from }} → {{ stats().fastestFlight?.to }} · {{
                        stats().fastestFlight?.date }}</span>
                    <span matListItemMeta class="stat-value">{{ getSpeed(stats().fastestFlight) | number : '1.0-0' }}
                        km/h</span>
                </mat-list-item>
                }
                <mat-divider></mat-divider>
                @if (stats().slowestFlight) {
                <mat-list-item [routerLink]="['/flight', stats().slowestFlight?._id]" class="clickable-item">
                    <mat-icon matListItemIcon>slower</mat-icon>
                    <span matListItemTitle>Slowest Flight</span>
                    <span matListItemLine>{{ stats().slowestFlight?.from }} → {{ stats().slowestFlight?.to }} · {{
                        stats().slowestFlight?.date }}</span>
                    <span matListItemMeta class="stat-value">{{ getSpeed(stats().slowestFlight) | number : '1.0-0' }}
                        km/h</span>
                </mat-list-item>
                }
            </mat-list>
        </mat-card-content>
    </mat-card>

    <!-- Extreme Locations Card -->
    <mat-card class="stats-card glass-card">
        <mat-card-header>
            <mat-icon mat-card-avatar>explore</mat-icon>
            <mat-card-title>Extremes</mat-card-title>
        </mat-card-header>
        <mat-card-content>
            <mat-list>
                @if (stats().extremeAirports.north) {
                <mat-list-item>
                    <mat-icon matListItemIcon>north</mat-icon>
                    <span matListItemTitle>Most Northern</span>
                    <span matListItemLine>{{ stats().extremeAirports.north?.name }} ({{
                        stats().extremeAirports.north?.code }})</span>
                    <span matListItemMeta class="stat-value">{{ stats().extremeAirports.north?.latitude | coordinate: 'latitude' }}</span>
                </mat-list-item>
                }
                <mat-divider></mat-divider>
                @if (stats().extremeAirports.south) {
                <mat-list-item>
                    <mat-icon matListItemIcon>south</mat-icon>
                    <span matListItemTitle>Most Southern</span>
                    <span matListItemLine>{{ stats().extremeAirports.south?.name }} ({{
                        stats().extremeAirports.south?.code }})</span>
                    <span matListItemMeta class="stat-value">{{ stats().extremeAirports.south?.latitude | coordinate: 'latitude' }}</span>
                </mat-list-item>
                }
                <mat-divider></mat-divider>
                @if (stats().extremeAirports.east) {
                <mat-list-item>
                    <mat-icon matListItemIcon>east</mat-icon>
                    <span matListItemTitle>Most Eastern</span>
                    <span matListItemLine>{{ stats().extremeAirports.east?.name }} ({{
                        stats().extremeAirports.east?.code }})</span>
                    <span matListItemMeta class="stat-value">{{ stats().extremeAirports.east?.longitude | coordinate: 'longitude' }}</span>
                </mat-list-item>
                }
                <mat-divider></mat-divider>
                @if (stats().extremeAirports.west) {
                <mat-list-item>
                    <mat-icon matListItemIcon>west</mat-icon>
                    <span matListItemTitle>Most Western</span>
                    <span matListItemLine>{{ stats().extremeAirports.west?.name }} ({{
                        stats().extremeAirports.west?.code }})</span>
                    <span matListItemMeta class="stat-value">{{ stats().extremeAirports.west?.longitude | coordinate: 'longitude' }}</span>
                </mat-list-item>
                }
            </mat-list>
        </mat-card-content>
    </mat-card>

    <!-- Rankings Section -->
    <div class="rankings-grid">
        <!-- Top Airlines -->
        <mat-card class="stats-card glass-card">
            <mat-card-header>
                <mat-icon mat-card-avatar>lan</mat-icon>
                <mat-card-title>Top Airlines</mat-card-title>
            </mat-card-header>
            <mat-card-content>
                <div class="chart-container">
                    @for (item of stats().topAirlines; track item.name) {
                    <div class="chart-row">
                        <div class="chart-label">
                            <img [src]="item.name | logo" class="airline-logo-mini" alt=""
                                (error)="$event.target.src='assets/logos/default_airline.svg'; $event.target.onerror=null">
                            {{ item.name }}
                        </div>
                        <div class="chart-value">{{ item.count }}</div>
                    </div>
                    }
                </div>
            </mat-card-content>
        </mat-card>

        <!-- Top Aircraft Types -->
        <mat-card class="stats-card glass-card">
            <mat-card-header>
                <mat-icon mat-card-avatar>flight_takeoff</mat-icon>
                <mat-card-title>Top Aircraft</mat-card-title>
            </mat-card-header>
            <mat-card-content>
                <div class="chart-container">
                    @for (item of stats().topAircraftTypes; track item.name) {
                    <div class="chart-row">
                        <div class="chart-label">
                            {{ item.name }}
                        </div>
                        <div class="chart-value">{{ item.count }}</div>
                    </div>
                    }
                </div>
            </mat-card-content>
        </mat-card>

        <!-- Top Planes (Registrations) -->
        <mat-card class="stats-card glass-card">
            <mat-card-header>
                <mat-icon mat-card-avatar>pin</mat-icon>
                <mat-card-title>Top Planes</mat-card-title>
            </mat-card-header>
            <mat-card-content>
                <div class="chart-container">
                    @for (item of stats().topRegistrations; track item.name) {
                    <div class="chart-row">
                        <div class="chart-label">{{ item.name }}</div>
                        <div class="chart-value">{{ item.count }}</div>
                    </div>
                    }
                </div>
            </mat-card-content>
        </mat-card>

        <!-- Top Routes -->
        <mat-card class="stats-card glass-card">
            <mat-card-header>
                <mat-icon mat-card-avatar>multiple_stop</mat-icon>
                <mat-card-title>Top Routes</mat-card-title>
            </mat-card-header>
            <mat-card-content>
                <div class="chart-container">
                    @for (item of stats().topRoutes; track item.name) {
                    <div class="chart-row">
                        <div class="chart-label">{{ getRouteLabel(item.name) }}</div>
                        <div class="chart-value">{{ item.count }}</div>
                    </div>
                    }
                </div>
            </mat-card-content>
        </mat-card>

        <!-- Top Airports -->
        <mat-card class="stats-card glass-card">
            <mat-card-header>
                <mat-icon mat-card-avatar>place</mat-icon>
                <mat-card-title>Top Airports</mat-card-title>
            </mat-card-header>
            <mat-card-content>
                <div class="chart-container">
                    @for (item of stats().topAirports; track item.name) {
                    <div class="chart-row">
                        <div class="chart-label">{{ item.name }}</div>
                        <div class="chart-value">{{ item.count }}</div>
                    </div>
                    }
                </div>
            </mat-card-content>
        </mat-card>

        <!-- Top Countries -->
        <mat-card class="stats-card glass-card">
            <mat-card-header>
                <mat-icon mat-card-avatar>public</mat-icon>
                <mat-card-title>Top Countries</mat-card-title>
            </mat-card-header>
            <mat-card-content>
                <div class="chart-container">
                    @for (item of stats().topCountries; track item.name) {
                    <div class="chart-row">
                        <div class="chart-label">{{ item.name }}</div>
                        <div class="chart-value">{{ item.count }}</div>
                    </div>
                    }
                </div>
            </mat-card-content>
        </mat-card>
    </div>

    <!-- Seat Class Breakdown -->
    <mat-card class="stats-card glass-card">
        <mat-card-header>
            <mat-icon mat-card-avatar>airline_seat_recline_extra</mat-icon>
            <mat-card-title>Seat Class Breakdown</mat-card-title>
        </mat-card-header>
        <mat-card-content>
            <div class="class-stats-grid">
                <div class="class-stat-column">
                    <h3>By Distance</h3>
                    <div class="chart-container">
                        @for (travelClass of stats().distanceByClass | keyvalue; track travelClass.key) {
                        <div class="chart-row">
                            <div class="chart-label">
                                <mat-chip-set>
                                    <mat-chip class="class-chip" [class]="getClassCss(travelClass.key.toString())">
                                        {{ getClassLabel(travelClass.key.toString()) }}
                                    </mat-chip>
                                </mat-chip-set>
                            </div>
                            <div class="chart-value">{{ travelClass.value | number : '1.0-0' }} km</div>
                        </div>
                        }
                    </div>
                </div>
                <div class="class-stat-column">
                    <h3>By Time</h3>
                    <div class="chart-container">
                        @for (travelClass of stats().timeByClass | keyvalue; track travelClass.key) {
                        <div class="chart-row">
                            <div class="chart-label">
                                <mat-chip-set>
                                    <mat-chip class="class-chip" [class]="getClassCss(travelClass.key.toString())">
                                        {{ getClassLabel(travelClass.key.toString()) }}
                                    </mat-chip>
                                </mat-chip-set>
                            </div>
                            <div class="chart-value">{{ travelClass.value | amDurationExact }}</div>
                        </div>
                        }
                    </div>
                </div>
            </div>
        </mat-card-content>
    </mat-card>
</div>